generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"   // ← change from "sqlite" to "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())

  sessions     Session[]
  memberships  Membership[]
  ownedTenants Tenant[] @relation("TenantOwner")
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Tenant {
  id                        String   @id @default(cuid())
  slug                      String   @unique
  storeName                 String
  billingPlan               String   @default("starter")
  starterLinkSlug           String?  @unique
  starterLinkEnabled        Boolean  @default(true)
  createdAt                 DateTime @default(now())
  ownerId                   String
  owner                     User     @relation("TenantOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  memberships               Membership[]
  widget                    Widget?
  knowledgeDocs             KnowledgeDoc[]
  conversations             Conversation[]
  metricEvents              MetricEvent[]
  twilioVoiceEvents         TwilioVoiceEvent[]
  designPartnerRolloutItems DesignPartnerRolloutItem[]
  phoneAgentSettings        PhoneAgentSettings?
  callSessions              CallSession[]           // ← NEW
  answerMachineItems        AnswerMachineItem[]     // ← NEW
}

model Membership {
  id        String   @id @default(cuid())
  role      String   // owner | staff
  createdAt DateTime @default(now())

  userId   String
  tenantId String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
}

model Widget {
  id         String   @id @default(cuid())
  tenantId   String   @unique
  publicKey  String   @unique @default(cuid())
  createdAt  DateTime @default(now())
  installedAt DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model KnowledgeDoc {
  id        String   @id @default(cuid())
  tenantId  String
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, updatedAt])
}

model Conversation {
  id                String   @id @default(cuid())
  tenantId          String
  channel           String   @default("web")
  status            String   @default("open")
  aiEnabled         Boolean  @default(true)
  customerName      String   @default("Customer")
  customerEmail     String?
  subject           String   @default("Support")
  tags              String   @default("")
  createdAt         DateTime @default(now())
  lastMessageAt     DateTime @default(now())
  archivedAt        DateTime?
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages          Message[]
  callSessions      CallSession[]             // ← NEW
  answerMachineItems AnswerMachineItem[]      // ← NEW
  @@index([tenantId, lastMessageAt])
  @@index([tenantId, archivedAt])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // customer | assistant | staff | note
  content        String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model MetricEvent {
  id        String   @id @default(cuid())
  tenantId  String?
  source    String
  event     String
  intent    String?
  createdAt DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([event, createdAt])
}

model TwilioVoiceEvent {
  id             String   @id @default(cuid())
  tenantId       String?
  provider       String   @default("twilio")
  eventType      String
  verification   String
  callSid        String?
  accountSid     String?
  streamSid      String?
  mos            Float?
  jitterMs       Float?
  packetLossPct  Float?
  roundTripMs    Float?
  rawPayload     String
  createdAt      DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([callSid, createdAt])
  @@index([eventType, createdAt])
}

model PhoneAgentSettings {
  id                      String   @id @default(cuid())
  tenantId                String   @unique
  inboundNumberE164       String?  @unique
  enabled                 Boolean  @default(false)
  voiceName               String?
  greeting                String?
  fallbackLine            String?
  afterHoursLine          String?
  afterHoursVoicemailOnly Boolean  @default(true)
  businessHoursJson       String?
  timeZone                String   @default("America/New_York")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  tenant                  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model CallSession {
  id                  String    @id @default(cuid())
  tenantId            String
  provider            String
  providerCallSid     String?
  fromNumber          String?
  toNumber            String?
  conversationId      String
  status              String    @default("IN_PROGRESS")
  fallbackTriggeredAt DateTime?
  endedAt             DateTime?
  createdAt           DateTime  @default(now())

  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation        Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  answerMachineItems  AnswerMachineItem[]
  callTurns           CallTurn[]
}

model AnswerMachineItem {
  id                String           @id @default(cuid())
  tenantId          String
  conversationId    String
  callSessionId     String?
  type              AnswerMachineType
  fromNumber        String?
  reason            String
  callbackNumber    String?
  callbackNotes     String?
  recordingUrl      String?
  transcriptText    String?
  status            AnswerMachineStatus @default(NEW)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation      Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  callSession       CallSession?     @relation(fields: [callSessionId], references: [id], onDelete: SetNull)
}

model CallTurn {
  id            String    @id @default(cuid())
  callSessionId String
  idx           Int
  sttText       String?
  assistantText String?
  llmMs         Int?
  createdAt     DateTime  @default(now())

  callSession   CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  @@unique([callSessionId, idx])
}

enum AnswerMachineType {
  VOICEMAIL
  CALLBACK
}

enum AnswerMachineStatus {
  NEW
  IN_PROGRESS
  DONE
  FAILED
}

model DesignPartnerRolloutItem {
  id          String   @id @default(cuid())
  tenantId    String
  key         String
  title       String
  description String?
  done        Boolean  @default(false)
  owner       String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId, done])
}
