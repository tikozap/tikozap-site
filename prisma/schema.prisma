// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

enum PlanTier {
  STARTER
  PRO
  BUSINESS
}

enum BillingStatus {
  NONE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
}

// =======================
// Milestone 9: Voice + Answer Machine enums
// =======================

enum CallProvider {
  TWILIO
}

enum CallStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum AnswerMachineType {
  VOICEMAIL
  CALLBACK
}

enum AnswerMachineStatus {
  NEW
  IN_PROGRESS
  DONE
}

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  name         String?
  passwordHash String?
  createdAt    DateTime     @default(now())
  memberships  Membership[]
  sessions     Session[]
  ownedTenants Tenant[]     @relation("TenantOwner")
}

model RateLimitBucket {
  id        String   @id @default(cuid())
  key       String   @unique
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resetAt])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Tenant {
  id        String   @id @default(cuid())
  slug      String   @unique
  storeName String
  createdAt DateTime @default(now())
  ownerId   String

  timeZone  String   @default("America/New_York")

  // Billing / Plan (MVP)
  plan          PlanTier      @default(PRO)
  billingStatus BillingStatus @default(NONE)
  trialEndsAt   DateTime?

  conversations Conversation[]
  knowledgeDocs KnowledgeDoc[]
  memberships   Membership[]
  starterLink   StarterLink?
  owner         User           @relation("TenantOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  widget        Widget?

  billingAccount BillingAccount?
  usageMonths    UsageMonth[]

  // =======================
  // Milestone 9: Voice + Answer Machine relations
  // =======================
  phoneAgentSettings PhoneAgentSettings?
  callSessions       CallSession[]
  answerMachineItems AnswerMachineItem[]
}

model Membership {
  id        String   @id @default(cuid())
  role      String
  createdAt DateTime @default(now())
  userId    String
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
}

model Widget {
  id            String    @id @default(cuid())
  tenantId      String    @unique
  publicKey     String    @unique @default(cuid())
  createdAt     DateTime  @default(now())
  installedAt   DateTime?
  enabled       Boolean   @default(true)
  assistantName String?
  greeting      String?
  brandColor    String?

  // ✅ Milestone 7: allowed-domain enforcement
  allowedDomains String[] @default([])

  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model KnowledgeDoc {
  id        String   @id @default(cuid())
  tenantId  String
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, updatedAt])
}

model Conversation {
  id            String    @id @default(cuid())
  tenantId      String
  channel       String    @default("web")
  status        String    @default("open")
  aiEnabled     Boolean   @default(true)
  customerName  String    @default("Customer")
  customerEmail String?
  subject       String    @default("Support")
  tags          String    @default("")
  createdAt     DateTime  @default(now())
  lastMessageAt DateTime  @default(now())
  archivedAt    DateTime?
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages      Message[]

  // =======================
  // Milestone 9: Voice + Answer Machine relations
  // =======================
  callSessions       CallSession[]
  answerMachineItems AnswerMachineItem[]

  @@index([tenantId, lastMessageAt])
  @@index([tenantId, archivedAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           String
  content        String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model StarterLink {
  id          String   @id @default(cuid())
  tenantId    String   @unique
  slug        String   @unique
  published   Boolean  @default(false)
  title       String?
  tagline     String?
  logoUrl     String?
  phone       String?
  address     String?
  city        String?
  hoursJson   String?
  buttonsJson String?
  greeting    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([published])
}

// =======================
// Milestone 8: Billing v1 + usage tracking
// =======================

model BillingAccount {
  id                   String   @id @default(cuid())
  tenantId             String   @unique

  stripeCustomerId     String   @unique
  stripeSubscriptionId String?  @unique
  stripePriceId        String?

  status               BillingStatus @default(NONE)
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean  @default(false)

  billingEmail         String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tenant               Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model BillingWebhookEvent {
  id        String   @id @default(cuid())
  provider  String   @default("stripe")
  eventId   String   @unique
  type      String
  createdAt DateTime @default(now())
  payload   Json

  @@index([type, createdAt])
}

model UsageMonth {
  id             String   @id @default(cuid())
  tenantId        String
  yearMonth       Int      // e.g. 202602

  messages        Int      @default(0)
  conversations   Int      @default(0)
  knowledgeChars  Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, yearMonth])
  @@index([tenantId, yearMonth])
}

// =======================
// Milestone 9: Voice Agent + Answer Machine models
// =======================

model PhoneAgentSettings {
  id                     String   @id @default(cuid())
  tenantId                String   @unique

  // ✅ NEW: the Twilio number assigned to this tenant (E.164 format)
  inboundNumberE164       String?  @unique

  enabled                 Boolean  @default(false)

  voiceName               String?
  greeting                String?
  fallbackLine            String?
  afterHoursLine          String?
  afterHoursVoicemailOnly Boolean  @default(true)

  businessHoursJson       String?
  timeZone                String   @default("America/New_York")

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  tenant                  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model CallSession {
  id               String       @id @default(cuid())
  tenantId          String
  provider          CallProvider @default(TWILIO)
  providerCallSid   String       @unique

  fromNumber        String?
  toNumber          String?

  status            CallStatus   @default(IN_PROGRESS)

  // Link every call to an Inbox thread (Conversation)
  conversationId    String
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  startedAt         DateTime     @default(now())
  endedAt           DateTime?

  fallbackTriggeredAt DateTime?

  turns             CallTurn[]
  answerItems       AnswerMachineItem[]

  tenant            Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, startedAt])
}

model CallTurn {
  id            String      @id @default(cuid())
  callSessionId String
  idx           Int

  sttText       String?
  assistantText String?

  sttMs         Int?
  llmMs         Int?
  ttsMs         Int?

  createdAt     DateTime    @default(now())
  callSession   CallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade)

  @@unique([callSessionId, idx])
  @@index([callSessionId, createdAt])
}

model AnswerMachineItem {
  id             String              @id @default(cuid())
  tenantId        String
  type           AnswerMachineType
  status         AnswerMachineStatus @default(NEW)

  // Tie to Inbox and optionally to a call session
  callSessionId   String?
  conversationId  String

  fromNumber      String?
  recordingUrl    String?
  transcriptText  String?

  callbackNumber  String?
  callbackNotes   String?

  // e.g. after_hours | dtmf_0 | dtmf_1 | fallback | disabled
  reason          String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  callSession     CallSession?  @relation(fields: [callSessionId], references: [id], onDelete: SetNull)
  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([tenantId, status, createdAt])
  @@index([conversationId])
}
