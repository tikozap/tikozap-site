import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export const runtime = 'nodejs';

function slugify(input: string) {
  return (input || '')
    .toLowerCase()
    .trim()
    .replace(/['"]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

export async function POST(req: Request) {
  try {
    const body: any = await req.json().catch(() => ({}));

    const tenantName = (body.tenantName || 'Three Tree Fashion').toString().trim();
    const tenantSlug = (body.tenantSlug || slugify(tenantName) || 'three-tree-fashion')
      .toString()
      .trim();

    const ownerEmail = (body.ownerEmail || 'owner@three-tree-fashion.demo').toString().trim();
    const ownerName = (body.ownerName || 'Demo Owner').toString().trim();

    const p: any = prisma as any;
    const model =
      p.tenant ?? p.Tenant ??
      p.workspace ?? p.Workspace ??
      p.merchant ?? p.Merchant;

    if (!model) {
      return NextResponse.json(
        { ok: false, error: 'No tenant model found in Prisma client.' },
        { status: 500 }
      );
    }

    const tenant = await model.upsert({
      where: { slug: tenantSlug },
      update: {
        // Your schema does NOT have `name`, so only update storeName
        storeName: tenantName,
      },
      create: {
        slug: tenantSlug,
        storeName: tenantName,
        owner: {
          connectOrCreate: {
            where: { email: ownerEmail },
            create: { email: ownerEmail, name: ownerName },
          },
        },
      },
    });

    return NextResponse.json({
      ok: true,
      tenant: { id: tenant?.id, slug: tenant?.slug, storeName: tenant?.storeName },
    });
  } catch (err: any) {
    console.error('[demo/bootstrap] error', err);
    return NextResponse.json(
      { ok: false, error: err?.message || 'bootstrap failed' },
      { status: 500 }
    );
  }
}
