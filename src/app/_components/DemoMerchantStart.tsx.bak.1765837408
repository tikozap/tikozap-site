'use client';

import { useEffect, useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';

const KEY_LOGIN = 'tz_demo_logged_in';
const KEY_ONBOARDED = 'tz_demo_onboarded';
const KEY_TENANT_NAME = 'tz_demo_tenant_name';
const KEY_TENANT_SLUG = 'tz_demo_tenant_slug';

function slugify(input: string) {
  return (input || '')
    .toLowerCase()
    .trim()
    .replace(/['"]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

function setCookie(name: string, value: string) {
  // non-httpOnly cookie (fine for demo/MVP). Server routes can read it if needed.
  document.cookie = `${name}=${encodeURIComponent(value)}; Path=/; Max-Age=${60 * 60 * 24 * 30}`;
}

function clearCookie(name: string) {
  document.cookie = `${name}=; Path=/; Max-Age=0`;
}

export default function DemoMerchantStart() {
  const router = useRouter();
  const [status, setStatus] = useState<{ loggedIn: boolean; onboarded: boolean }>({
    loggedIn: false,
    onboarded: false,
  });
  const [busy, setBusy] = useState(false);

  const qs = useMemo(() => {
    if (typeof window === 'undefined') return new URLSearchParams();
    return new URLSearchParams(window.location.search);
  }, []);

  const tenantNameFromQS = qs.get('storeName') || qs.get('tenantName') || qs.get('store') || '';
  const tenantName = tenantNameFromQS || 'Three Tree Fashion';
  const tenantSlug = slugify(tenantName) || 'three-tree-fashion';

  useEffect(() => {
    const loggedIn = localStorage.getItem(KEY_LOGIN) === '1';
    const onboarded = localStorage.getItem(KEY_ONBOARDED) === '1';
    setStatus({ loggedIn, onboarded });
  }, []);

  const start = async () => {
    setBusy(true);
    try {
      // 1) Ensure the tenant exists in DB (so /onboarding/test can save messages)
      const res = await fetch('/api/demo/bootstrap', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tenantName, tenantSlug }),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) {
        throw new Error(data?.error || 'Failed to bootstrap demo tenant.');
      }

      // 2) Client-side demo state (UI routing)
      localStorage.setItem(KEY_LOGIN, '1');
      localStorage.setItem(KEY_TENANT_NAME, tenantName);
      localStorage.setItem(KEY_TENANT_SLUG, tenantSlug);

      // 3) Also set cookies (helps server routes if they need tenant context)
      setCookie('tz_demo_logged_in', '1');
      setCookie('tz_demo_tenant_name', tenantName);
      setCookie('tz_demo_tenant_slug', tenantSlug);

      const onboarded = localStorage.getItem(KEY_ONBOARDED) === '1';
      router.push(onboarded ? '/dashboard/conversations' : '/onboarding');
    } catch (e: any) {
      alert(e?.message || 'Demo start failed.');
    } finally {
      setBusy(false);
    }
  };

  const reset = () => {
    localStorage.removeItem(KEY_LOGIN);
    localStorage.removeItem(KEY_ONBOARDED);
    localStorage.removeItem(KEY_TENANT_NAME);
    localStorage.removeItem(KEY_TENANT_SLUG);

    clearCookie('tz_demo_logged_in');
    clearCookie('tz_demo_tenant_name');
    clearCookie('tz_demo_tenant_slug');

    setStatus({ loggedIn: false, onboarded: false });
  };

  return (
    <div style={{ marginTop: 16, border: '1px solid #e5e7eb', borderRadius: 14, padding: 14, background: '#fff' }}>
      <div style={{ fontWeight: 700, marginBottom: 6 }}>Demo merchant quick start</div>
      <div style={{ fontSize: 13, opacity: 0.85, marginBottom: 10 }}>
        Tenant: <b>{tenantName}</b> • Status: {status.loggedIn ? 'Logged in' : 'Logged out'} •{' '}
        {status.onboarded ? 'Onboarding complete' : 'Needs onboarding'}
      </div>

      <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap' }}>
        <button
          onClick={start}
          disabled={busy}
          style={{
            borderRadius: 12,
            padding: '10px 12px',
            border: '1px solid #111827',
            background: '#111827',
            color: '#fff',
            cursor: busy ? 'not-allowed' : 'pointer',
            opacity: busy ? 0.8 : 1,
          }}
        >
          {busy ? 'Starting…' : `Continue as ${tenantName}`}
        </button>

        <button
          onClick={reset}
          disabled={busy}
          style={{
            borderRadius: 12,
            padding: '10px 12px',
            border: '1px solid #d1d5db',
            background: '#fff',
            cursor: busy ? 'not-allowed' : 'pointer',
          }}
        >
          Reset demo
        </button>
      </div>
    </div>
  );
}
